/**
 * 根据个人的编程习惯，封装的一个微信小程序网络请求框架。
 * 为的就是降低代码的偶合，提高代码的可维护性。
 * @author huangxunyue <h88305@qq.com>
 */var Config=require("config.js")||{},hexMd5=require("md5.js"),requestQueue=[],requestCookie="";wx.SQ=wx.SQ||function(H,h){function I(a){var b=typeof a;if("undefined"==b)return!0;switch(b){case "string":return 0==a.length;case "boolean":return!a;case "number":return!a;case "object":for(var e in a)return!1;return!0;default:return!1}}function J(a){function b(a,c){var e=c.indexOf(".");if(0<e){var d=c.substr(0,e);return a[d]?b(a[d],c.substr(e+1)):!1}return a[c]||!1}function e(a,b,c,d){a=a||{};var w=c.indexOf(".");if(0<w){var g=c.substr(0,w);a[g]=e(a[g],b,c.substr(w+1),d)}else a[c]=(d||l&&1<f)&&null!=a[c]&&"object"==typeof a[c]&&0<a[c].length?a[c].concat(b):b;return a}if("object"==typeof h&&"object"==typeof a&&0<m.length){var d=h.data,D;for(D in m){var k=m[D],g=b(a,k.name);if("string"==typeof k.alias&&0===k.alias.indexOf("@")){if(I(g))continue;k.alias=k.alias.substr(1)}d=e(d,g,k.alias,k.merge)}h.setData(d)}}function x(a,b){a=a.lastIndexOf("/")===a.length-1?a:a+"/";b=0===b.indexOf("/")?b.substr(1):b;return a+b}function y(){return wx.getStorageSync("_request_global_param_")||{}}var b={},d={url:null,data:{}},K=Config.contentType,z=Config.saveCookie||!1,E=Config.requestSign||!1,n=Config.signParamName||"sign",A=Config.pageParamName||"page",B=Config.pageSizeParamName||"pageSize",F=Config.isOffset||!1,f=1,p=10,C=null,g=!0,l=!1,q=[],m=[],r=null,t=null,u=null,v=0,G="\u73a9\u547d\u52a0\u8f7d\u4e2d";h=h||{};b.url=function(a){if(a){var c=Config.urlBase;c[a]?(d.url=x(x(Config.domain,Config.commonUrl),c[a].url),q=c[a].param||[]):d.url=/^[A-Za-z]+:\/\//.test(a)?a:x(Config.domain,a);return b}return d.url};b.pageObject=function(a){h=a;return b};b.sign=function(a,c,e){E=a?!0:!1;n=c||n;return b};b.paging=function(a,c,e){l=!0;p=a||10;A=c||A;B=e||B;!1!==arguments[arguments.length-1]&&(h.onPullDownRefresh=function(){b.pagingRefresh()},h.onReachBottom=function(){b.pagingLoading()});return b.page(f).param(B,p)};b.offset=function(a,c,e){F=!0;return b.paging(a,c,e)};b.pagingWhere=function(a){"function"==typeof a&&(C=a);return b};b.pagingRefresh=function(a){l&&(b.page(1).run(a),wx.stopPullDownRefresh())};b.pagingLoading=function(a){l&&g&&b.run(a)};b.currentPage=function(){return f};b.page=function(a){f=1<a?a:1;g=1==f?!0:g;return b.param(A,F?(f-1)*p:f)};b.nextPage=function(a){f+=a||1;return b.page(f)};b.prevPage=function(a){f+=a||1;return b.page(f)};b.param=function(a,c){d.data=d.data||{};var e=/^[-\+]?\d+(\.\d+)$/;d.data[a]="number"==typeof c&&e.test(c)?c.toString():c;return b};b.params=function(){for(var a in arguments)q[a]&&b.param(q[a],arguments[a]);return b};b.paramObject=function(a,c){if("object"==typeof a)for(var e in a)!0===c?b.param(q[e],a[e]):b.param(e,a[e]);return b};b.getParam=function(a){return a?d.data[a]:d.data};b.removeParam=function(a){d.data&&d.data[a]&&delete d.data[a];return b};b.globalParam=function(a,c){var e=y();e[a]=c;wx.setStorageSync("_request_global_param_",e);return b.param(a,c)};b.removeGlobalParam=function(a,c){var e=y();!c&&e[a]&&(delete e[a],wx.setStorageSync("_request_global_param_",e));return b.removeParam(a)};b.assign=function(){var a=!0===arguments[arguments.length-1]?!0:!1,c=0===arguments[arguments.length-1]?!0:!1,e;for(e in arguments){var d=arguments[e];if(d&&"string"==typeof d){var d=d.split(":"),f=d[1]||d[0],f=c&&0!==f.indexOf("@")?"@"+f:f;m.push({name:d[0],alias:f,merge:a})}}return b};b.loading=function(a){!1===a?v=!1:"number"==typeof a?v=a?1:0:G=a;return b};b.method=function(a){d.method=a;return b};b.dataType=function(a){d.dataType=a;return b};b.header=function(a,c){d.header=d.header||{};switch(typeof a){case "string":d.header[a]=c;break;case "object":d.header=a}return b};b.contentType=function(a){!0===a?b.header("content-type","application/x-www-form-urlencoded"):"string"==typeof a?b.header("content-type",a):b.header("content-type","application/json");return b};b.cookie=function(a){"boolean"==typeof a?z=a:"string"==typeof a?requestCookie=a:z=!0;return b};b.sync=function(){d.async=!1;return b};b.get=function(a,c,d){b.run(a,c,d)};b.post=function(a,c,d){b.method("POST").run(a,c,d)};b.run=function(a,c,e){g&&(!l||0>requestQueue.indexOf(d.url))&&(r=a||r,t=c||t,u=e||u,z&&requestCookie&&b.header("cookie",requestCookie),1===v?wx.showNavigationBarLoading():0===v&&wx.showLoading({title:G}),E&&(b.removeParam(n),b.param("timestamp",parseInt((new Date).getTime()/1E3)),a=b.getParam(),a=JSON.stringify(a),a=hexMd5(a),a=hexMd5(a+Config.signSecret),b.param(n,a)),requestQueue.push(d.url),wx.request(d))};(function(){var a=y(),c;for(c in a)b.param(c,a[c])})();(function(){d.success=function(a){J(a.data);var c=a.data;if(l&&null!=c&&"object"==typeof c){var d=c.page?c.page:f,h=c.pageSize?c.pageSize:p;"function"==typeof C?C(c,d,h)?b.page(d+1):g=!1:c.totalPage||c.data?c.totalPage<=d||c.data&&c.data.length<h?g=!1:b.page(d+1):b.page(d+1)}"function"==typeof r&&r(a.data,a,b)};d.fail=function(a){"function"==typeof t&&t(a,b)};d.complete=function(a){requestCookie=a.header?a.header["Set-Cookie"]:"";requestQueue.splice(requestQueue.indexOf(d.url),1);"function"==typeof u&&u(a,b);0>=requestQueue.length&&(wx.hideNavigationBarLoading(),wx.hideLoading())}})();b.contentType(K);b.url(H);return b};